---
title: "DATA 622 HW4 - Clustering, PCA and SVM"
author: "Mael Illien, Dhairav Chhatbar, Santosh Manjrekar"
date: "4/12/2021"
output: 
  html_document:
    code_folding: show
    theme: cosmo
    highlight: tango
    toc: true
    number_section: false
    toc_float:
      collapsed: true
      smooth_scroll: true
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup

```{r message=FALSE, warning=FALSE}
library(skimr)
library(tidyverse)
library(caret) # For featureplot, classification report
library(corrplot) # For correlation matrix
library(AppliedPredictiveModeling)
library(mice) # For data imputation
library(VIM) # For missing data visualization
library(gridExtra) # For grid plots
library(pROC) # For AUC calculations
library(ROCR) # For ROC and AUC plots
library(dendextend)
library(factoextra)
```


# ADHD Dataset

```{r}
adhd_raw <- read.csv('https://raw.githubusercontent.com/maelillien/data622/main/hw4/adhd_data.csv', header = TRUE)
adhd <- adhd_raw
```

```{r}
head(adhd)
```

```{r}
adhd[adhd==''] <- NA 
skim(adhd)
```


## Data Pre-processing

Variables need to be numeric, computations based on distance.

```{r}
# Selecting only variables not containing Qs
adhd <- adhd %>% select(c(Age, Sex, Race, ADHD.Total, MD.TOTAL, Alcohol:Psych.meds.))
# Renaming variables
adhd <- rename(adhd, ADHDTotal = ADHD.Total, MDTotal = MD.TOTAL, Sedatives = Sedative.hypnotics, CourtOrder = Court.order, 
               Violence = Hx.of.Violence, Conduct = Disorderly.Conduct, NonSubstDX = Non.subst.Dx, SubstDX = Subst.Dx, PsychMeds = Psych.meds.)

# shift sex variable to 0 and 1
adhd$Sex <- adhd$Sex-1


```

```{r}
#adhd <- data.frame(lapply(adhd,as.numeric))
adhd <- mutate_all(adhd, function(x) as.numeric(as.character(x)))
```






#### Imputation of Missing Values

```{r}
mice_plot <- aggr(adhd, col=c('#F8766D','#00BFC4'), numbers=TRUE, sortVars=TRUE, labels=names(adhd), cex.axis=.7, gap=3, ylab=c("Missing data","Pattern"))
```

```{r}
dim(adhd)
```


```{r}
# Discard PsychMeds
adhd.complete <- adhd %>% select(-c(PsychMeds))

# Keep only complete cases
adhd.complete <- adhd.complete[complete.cases(adhd.complete),]
```

```{r}
dim(adhd.complete)
```

## Data Exploration



## Data Processing

```{r}
# Re-coding Education Variable, College = Education > 12, HS = Education > 8 & <= 12, MS = Education <= 8 
adhd.complete$Education <- ifelse(adhd.complete$Education <= 8, 1, ifelse(adhd.complete$Education <= 12 & adhd.complete$Education > 8, 2, ifelse(adhd.complete$Education > 12, 3, 99)))
# Creating new variables based on type of abuse
adhd.complete$AbuseP <- as.numeric(adhd.complete$Abuse == 1 | adhd.complete$Abuse == 4 | adhd.complete$Abuse == 5 | adhd.complete$Abuse == 7)
adhd.complete$AbuseS <- as.numeric(adhd.complete$Abuse == 2 | adhd.complete$Abuse == 4 | adhd.complete$Abuse == 6 | adhd.complete$Abuse == 7)
adhd.complete$AbuseE <- as.numeric(adhd.complete$Abuse == 3 | adhd.complete$Abuse == 5 | adhd.complete$Abuse == 6 | adhd.complete$Abuse == 7)
adhd.complete <- adhd.complete %>% select(-c(Abuse))

```

```{r}
head(adhd.complete)
```


Data must be scaled

```{r}
adhd.scaled <- scale(adhd.complete)
```


# Clustering

```{r}
# Dissimilarity matrix
d <- dist(adhd.scaled, method = "euclidean")

# Hierarchical clustering using Complete Linkage
hc1 <- hclust(d, method = "complete" )
```

```{r}
sub_grp <- cutree(hc1, k = 6)
table(sub_grp)
```

```{r}
adhd.complete %>%
  mutate(cluster = sub_grp) %>%
  head
```

```{r}
adhd.complete %>%
  mutate(cluster = sub_grp) %>%
  group_by(cluster) %>%
  summarise(meanAge = mean(Age), meanMD = mean(MDTotal), meanADHD = mean(ADHDTotal), count = n())
```



```{r, fig.width = 12}
dend <- adhd.complete %>%  scale %>% 
        dist %>% hclust %>% as.dendrogram
dend %>% set("branches_k_color", k = 6) %>% plot(main = "HC")
```




```{r, fig.width = 12}
dend <- adhd.complete %>%  scale %>% 
        dist %>% hclust(method = "average") %>% as.dendrogram
dend %>% set("branches_k_color", k = 10) %>% plot(main = "HC")

```


# PCA

```{r}
data.pca <- adhd.complete

res.pca <- prcomp(data.pca, scale = TRUE)
```

```{r}
# Results for Variables
res.var <- get_pca_var(res.pca)
#res.var$coord          # Coordinates
res.var$contrib[,1:5]        # Contributions to the PCs
```


```{r}
fviz_eig(res.pca)
```

```{r}
fviz_pca_ind(res.pca,
             col.ind = "cos2", # Color by the quality of representation
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
```

```{r}
fviz_pca_var(res.pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
```

```{r}
pca_data.adhd <- adhd_raw %>% select(ADHD.Q1:ADHD.Q18)
pca_data.md <- adhd_raw %>% select(MD.Q1a:MD.Q3)
```

```{r}
res.pca.adhd <- prcomp(pca_data.adhd, scale = FALSE)
res.var <- get_pca_var(res.pca.adhd)
fviz_eig(res.pca.adhd)
```

```{r}
res.var$contrib[,1:3]        # Contributions to the PCs
```

```{r}
res.pca.md <- prcomp(pca_data.md, scale = FALSE)
res.var <- get_pca_var(res.pca.md)
fviz_eig(res.pca.md)
```

```{r}
res.var$contrib[,1:4]        # Contributions to the PCs
```


# SVM



