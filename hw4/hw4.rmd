---
title: "DATA 622 HW4 - Clustering, PCA and SVM"
author: "Mael Illien, Dhairav Chhatbar, Santosh Manjrekar"
date: "4/12/2021"
output: 
  html_document:
    code_folding: hide
    theme: cosmo
    highlight: tango
    toc: true
    number_section: false
    toc_float:
      collapsed: true
      smooth_scroll: true
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup

```{r message=FALSE, warning=FALSE}
library(skimr)
library(tidyverse)
library(caret) # For featureplot, classification report
library(corrplot) # For correlation matrix and PCA contributionplots
library(AppliedPredictiveModeling)
library(mice) # For data imputation
library(VIM) # For missing data visualization
library(gridExtra) # For grid plots
library(pROC) # For AUC calculations
library(ROCR) # For ROC and AUC plots
library(dendextend) # For dendrograms
library(factoextra) # For PCA plots
library(e1071) # For SVM
```


# ADHD Dataset

This dataset is composed of real patient responses to two questionnaires related to ADHD and Mood Disorder and a variety of demographic, abuse and drug use variarables. For each questionnaire, the responses to individual questions are provided along with total scores. Links to the actual questions are provided below:

  - [Adult ADHD Self-Report Scale Symptom Checklis](https://add.org/wp-content/uploads/2015/03/adhd-questionnaire-ASRS111.pdf)
  - [Mood Disorder Questionnaire](https://www.ohsu.edu/sites/default/files/2019-06/cms-quality-bipolar_disorder_mdq_screener.pdf)

The first part of this work will make use of unsupervised learning techniques such as Principal Component Analysis (PCA) and clustering in an attempt to discover structures in the data. The second part will explore support vector machines in a supervised learning exercise to predict whether an individual has attempted suicide.

# Data

The dataset is composed of 54 variables and 175 observations. The data is coded as `numeric` and holds 33 observations that have some level of missing data. A summary of the variable distributions is provided below:

```{r message=FALSE, warning=FALSE}
adhd_raw <- read.csv('https://raw.githubusercontent.com/maelillien/data622/main/hw4/adhd_data.csv', header = TRUE)
adhd <- adhd_raw
head(adhd)
```

```{r message=FALSE, warning=FALSE}
adhd[adhd==''] <- NA 
skim(adhd %>% select(-c(ADHD.Q1:ADHD.Q18, MD.Q1a:MD.Q3)))
```


## Data Processing

The dataset is modified to include an `EducationLevel` categorical variable derived from the numerical `Education` variables representing the years of schooling. The `Abuse` column is unfolded into 3 binary variables indicating the occurence of the 3 types of abuse. The original `Abuse` variable is dropped.

We work with a multiple subsets of the data for subsequent parts this report. Some analyses make use of the entire set of questionnaire reponses while others use only the total score. 

```{r message=FALSE, warning=FALSE}
# Renaming variables
adhd <- rename(adhd, ADHDTotal = ADHD.Total, MDTotal = MD.TOTAL, Sedatives = Sedative.hypnotics, CourtOrder = Court.order, 
               Violence = Hx.of.Violence, Conduct = Disorderly.Conduct, NonSubstDX = Non.subst.Dx, SubstDX = Subst.Dx, PsychMeds = Psych.meds.)
# Drop Initial column
adhd <- adhd %>% select(-c(Initial))
# Shift sex variable to 0 and 1
adhd$Sex <- adhd$Sex-1
# Re-coding Education Variable, College = Education > 12, HS = Education > 8 & <= 12, MS = Education <= 8 
adhd$EducationLevel <- ifelse(adhd$Education <= 8, 1, ifelse(adhd$Education <= 12 & adhd$Education > 8, 2, ifelse(adhd$Education > 12, 3, 99)))
# Creating new variables based on type of abuse
adhd$AbuseP <- as.numeric(adhd$Abuse == 1 | adhd$Abuse == 4 | adhd$Abuse == 5 | adhd$Abuse == 7)
adhd$AbuseS <- as.numeric(adhd$Abuse == 2 | adhd$Abuse == 4 | adhd$Abuse == 6 | adhd$Abuse == 7)
adhd$AbuseE <- as.numeric(adhd$Abuse == 3 | adhd$Abuse == 5 | adhd$Abuse == 6 | adhd$Abuse == 7)
adhd <- adhd %>% select(-c(Abuse))
# Forming data subsets: full set of variables or reduced (totals only)
adhd.full <- adhd
adhd.red <- adhd %>% select(c(Age, Sex, Race, ADHDTotal, MDTotal, Alcohol:AbuseE))
# Set all characters to numeric
adhd.red <- mutate_all(adhd.red, function(x) as.numeric(as.character(x)))
adhd.full <- mutate_all(adhd.full, function(x) as.numeric(as.character(x)))
```

#### Missing Values

The dataset contains a few missing values. The PsychMeds variable mostly contained missing values and was dropped entirely. A few observations were quite sparse and only contained basic demographic and questionnaire score columns. In order to avoid biasing the dataset with imputed values, we preferred to drop all observations with missing values from the dataset. The resulting dataset contains 33 fewer observations with 142 complete rows and 19 columns.

```{r message=FALSE, warning=FALSE}
mice_plot <- aggr(adhd.red, col=c('#F8766D','#00BFC4'), numbers=TRUE, sortVars=TRUE, labels=names(adhd.red), cex.axis=.7, gap=3, ylab=c("Missing data","Pattern"))
```

```{r message=FALSE, warning=FALSE}
# Discard PsychMeds
adhd.red.complete <- adhd.red %>% select(-c(PsychMeds))
adhd.full.complete <- adhd.full %>% select(-c(PsychMeds))
# Keep only complete cases
adhd.red.complete <- adhd.red.complete[complete.cases(adhd.red.complete),]
adhd.full.complete <- adhd.full.complete[complete.cases(adhd.full.complete),]
```

## Data Exploration





# Clustering

Clustering refers to a broad set of techniques for finding subgroups, or clusters, in a dataset. We seek to partition observations into distinct groups so that the observations within each group are quite similar to each other, while observations in different groups are quite different from each other. The most popular clustering approaches are K-means and Hierarchical Clustering (HC). While the former requires a pre-specified number of clusters k, the latter does not. HC is a bottom-up or agglomerative clustering approach which results in an upside-down tree representation, built from the leaves and combined into clusters up to the trunk. Clusters are identified by horizontal cuts across the dendrogram.

In this section, we explore the use of Hierarchical Clustering on two portions of the data. The first uses only the questionnaire responses to ADHD while the second uses the total questionnaire scores for both surveys as well as the other variables (demographic, drugs, abuse, etc). The latter is referred to as the 'reduced' dataset.

Clustering typically requires the variables to be scaled in order to avoid more weight to variables using a larger range of values. However, when all the variables under conideration are measured on the same scale, which is the case when only comparing survey responses, it can be appropriate to leave the variables unscaled.

With HC, the concept of dissimilarity between a pair of observations needs to be extended to a pair of groups of observations. This extension is achieved with the notion of linkage, which defines the dissimilarity between two groups of observations. The resulting dendrogram heavily depends on the choice of linkage. The most popular linkages are complete and average because they tend to result in more balanced clusters. 

### ADHD Questionnaire

Using only the individual unscaled responses to the ADHD Questionnaire, we obtain the following dendrogram structure using complete linkage. In this case, complete linkage provided the best balancing and a cutoff into 3 clusters looked appropriate. In order to gain insight into these clusters, we need to look at the distribution of the variables within each of them. 

For these 3 clusters, we can make the following observations:

  - The clusters have very similar average age.
  - The consistuents of cluster 3 have the lowest average ADHD and Mood Disorder total scores.
  - Cluster 1 in on the other end of the spectrum and has the largest average lowest average ADHD and Mood Disorder total scores.
  - Clusters 2 is the largest subgroup with scores falling in between clusters 1 and 3 
  
We can establish a ranking for this clustering based on the monotic rise in the meanADHD and meanMD across clusters. From less to most severe: Cluster 3, Cluster 2, Cluster 1. With this information, a treatment plan could be developped to focus on clusters 2 and 1, with the latter requiring special attention.

```{r message=FALSE, warning=FALSE}
hc0 <- adhd.full %>% select(ADHD.Q1:ADHD.Q18) %>% dist(method = "euclidean") %>% hclust(method = "complete")
dend0 <- hc0 %>% as.dendrogram
sub_grp0 <- cutree(dend0, k = 3, order_clusters_as_data = TRUE)
dend0 %>% set("branches_k_color", k = 3) %>% set("labels", "") %>% plot(main = "Hierarchical Clustering ADHD Questionnaire")
```

```{r message=FALSE, warning=FALSE}
adhd.full %>%
  mutate(cluster = sub_grp0) %>%
  group_by(cluster) %>%
  summarise(meanAge = mean(Age), meanMD = mean(MDTotal), meanADHD = mean(ADHDTotal), count = n()) %>%
  gather(var,value,meanAge:count) %>%
  ggplot(aes(cluster,value,fill=cluster)) + 
  geom_col() + facet_grid(var ~ ., scales="free_y") +
  geom_text(aes(label=round(value,1)), vjust=1.6, color="white", size=3.5) + 
  ggtitle('ADHD Questionnaire Cluster Distribution')  +
  theme_minimal()
```

### Reduced Dataset

For a contrasting analysis, we looked at clustering based on the dataset which included only the total questionnaire scores and dropped observations with missing values. The variables were scaled to balance out the contribution of the high values for scores and age. We explore the use of complete, average and Ward linkages.

#### Complete Linkage

Unlike the previous clustering, adding the other variables results in a less balanced dendrogram. In this case, there are a few clusters containing only a few observations and two large clusters containing the majority of the data. We can make a few additional observations:

  - The largest cluster has the highest meanAge but the lowest average ADHD and MD scores. The value for meanADHD in this group is about twice the value of the least severe group in the previous cluster (ADHD only). 
  - Clusters 5 and 6 are the smallest and youngest grouping on average. Interestly, the individuals making up these groups are on the highest end of the meanADHD and meanMD variables. These individual may consitute a subgroup for potential treatment.
  - Clusters 1 and 3 are have very close meanMD values but remain dissimilar in terms of age and meanADHD scores. Cluster 3 is on average older by about 6 years but Cluster 1 has nearly 10 more ADHD points. 

Based on the variable distributions, it might be tempting to want to group clusters 4, 5 and 6 together since they represent a younger cohort with similar meanMD and meanADHD scores. However, hierachichal clustering considers more variables than the aforementioned few and this kind of grouping would violate the measure of similarity as determined by the y axis of the dendrogram.

A proposed ADHD and Mood Disorder ranking in 4 levels from least severe to most severe is: Cluster 2, Clusters 3 (younger) & 4 (older), Clusters 5 (younger) & 1 (older), Cluster 6.

```{r message=FALSE, warning=FALSE}
hc1 <- adhd.red.complete %>%  scale %>% dist(method = "euclidean") %>% hclust(method = "complete")
dend1 <- hc1 %>% as.dendrogram
sub_grp1 <- cutree(dend1, k = 6)
dend1 %>% set("branches_k_color", k = 6) %>% set("labels", "") %>% plot(main = "Hierachical Clustering Reduced Dataset + Complete Linkage")
```


```{r message=FALSE, warning=FALSE}
adhd.red.complete %>%
  mutate(cluster = sub_grp1) %>%
  group_by(cluster) %>%
  summarise(meanAge = mean(Age), meanMD = mean(MDTotal), meanADHD = mean(ADHDTotal), count = n()) %>%
  gather(var,value,meanAge:count) %>%
  ggplot(aes(cluster,value,fill=cluster)) + 
  geom_col() + facet_grid(var ~ ., scales="free_y") +
  geom_text(aes(label=round(value,1)), vjust=1.6, color="white", size=3.5) + 
  ggtitle('Reduced Dataset + Complete Linkage Cluster Distribution') +
  theme_minimal()
```

#### Average Linkage

Average linkage completely changes the dendrogram representation. The same number of clusters, k=6 seemed appropriate. Similarly to complete linkage, one large cluster is identified, this time containing the vast majority of the observations. This obscures the analysis beyond what we can establish about the small clusters. 

  - Clusters 6 and Cluster 5, both of size 1, represented the most severe and less severe cases respectively. It is interesting to note that Cluster 5 in more similar to the rest of the data in term of hierachy than to Cluster 6. 
  - Cluster 4 contains a handful of individuals that might also be considered severe. 
  - The large Cluster 2 must contain a variety of individuals that may have large variations in ADHD and MD scores but are nevertheless similar based on other attributes.

```{r message=FALSE, warning=FALSE}
hc2 <- adhd.red.complete %>%  scale %>% dist(method = "euclidean") %>% hclust(method =  'average')
dend2 <- hc2 %>% as.dendrogram
sub_grp2 <- cutree(dend2, k = 6)
dend2 %>% set("branches_k_color", k = 6) %>% set("labels", "") %>% plot(main = "Hierachical Clustering Reduced Dataset + Average Linkage")
```

```{r message=FALSE, warning=FALSE}
adhd.red.complete %>%
  mutate(cluster = sub_grp2) %>%
  group_by(cluster) %>%
  summarise(meanAge = mean(Age), meanMD = mean(MDTotal), meanADHD = mean(ADHDTotal), count = n()) %>%
  gather(var,value,meanAge:count) %>%
  ggplot(aes(cluster,value,fill=cluster)) + 
  geom_col() + facet_grid(var ~ ., scales="free_y") +
  geom_text(aes(label=round(value,1)), vjust=1.6, color="white", size=3.5) + 
  ggtitle('Reduced Dataset + Average Linkage Cluster Distribution') +
  theme_minimal()
```

#### Ward Linkage

While average linkage is a popular option, the resulting clustering above was somewhat unattractive. Here we consider another linkage method to expand the analysis. Ward linkage makes use of Ward's minimum variance criterion whcih seeks to minimizes the total within-cluster variance. The resulting dendrogram is visually attractive and more balanced than before. A cutoff at k=5 clusters seems appropriate. While more balanced, the insights drawn from the variable distributions across the clusters are not as obvious as when using complete linkage. It is harder to determine the least and most severe clusters as the grouping with the lower meanMD score also has the highest meanADHD score. Clusters 1 and 3 have similar questionnaire scores while differing by more than 10 years on average.

```{r message=FALSE, warning=FALSE}
hc3 <- adhd.red.complete %>%  scale %>% dist(method = "euclidean") %>% hclust(method =  'ward.D')
dend3 <- hc3 %>% as.dendrogram
sub_grp3 <- cutree(dend3, k = 5)
dend3 %>% set("branches_k_color", k = 5) %>% set("labels", "") %>% plot(main = "Hierachical Clustering Reduced Dataset + Ward Linkage")
```

```{r message=FALSE, warning=FALSE}
adhd.red.complete %>%
  mutate(cluster = sub_grp3) %>%
  group_by(cluster) %>%
  summarise(meanAge = mean(Age), meanMD = mean(MDTotal), meanADHD = mean(ADHDTotal), count = n()) %>%
  gather(var,value,meanAge:count) %>%
  ggplot(aes(cluster,value,fill=cluster)) + 
  geom_col() + facet_grid(var ~ ., scales="free_y") +
  geom_text(aes(label=round(value,1)), vjust=1.6, color="white", size=3.5) + 
  ggtitle('Reduced Dataset + Ward Linkage Cluster Distribution') +
  theme_minimal()
```

### Comparison

We use a tanglegram to obtain side-by-side comparisons on the clusters obtained using the different linkage methods. Here we only compare the complete and average linkage clusterings which are similar in terms of cluster imbalance. The first thing to notice is the consistency of groupings at the higher ends of the hiearchies. This is shown by the horizontal ribbon linking the two clustering and indicates that the selected observations end up in the corresponsing cluster representation. Naturally, a large number of observations find correspondence in the opposing largest clusters. A few observations cross the tanglegram to the opposite corner from smaller clusters. Further study of these patients might be of interest. 

```{r message=FALSE, warning=FALSE}
dl <- dendlist(
  dend1 %>% 
    set("labels_col", k=6) %>%
    set("branches_lty", 1) %>%
    set("branches_k_color", k = 6),
  dend2 %>% 
    set("labels_col", k=6) %>%
    set("branches_lty", 1) %>%
    set("branches_k_color", k = 6)
)
 
# Plot them together
tanglegram(dl,
           common_subtrees_color_lines = TRUE, highlight_distinct_edges  = TRUE, highlight_branches_lwd=FALSE,
           margin_inner=7,
           lwd=2,
           show_labels = FALSE
)
title("Complete Linkage vs Average")
```

[MI: comment or delete]

```{r message=FALSE, warning=FALSE}
dl <- dendlist(
  dend1 %>% 
    set("labels_col", k=6) %>%
    set("branches_lty", 1) %>%
    set("branches_k_color", k = 6),
  dend3 %>% 
    set("labels_col", k=5) %>%
    set("branches_lty", 1) %>%
    set("branches_k_color", k = 5)
)
 
# Plot them together
tanglegram(dl,
           common_subtrees_color_lines = TRUE, highlight_distinct_edges  = TRUE, highlight_branches_lwd=FALSE,
           margin_inner=7,
           lwd=2,
           show_labels = FALSE
)
title("Complete Linkage vs Ward Linkage")
```

# Principal Component Analysis

Principal Comnponent Analysis (PCA) is a dimensionality reduction technique where a dataset is transformed to use p eigenvectors of the covariance matrix instead of the original number of predictors n, where p < n. The number of eigenvectors p is selected by looking at the sorted eigenvalues and determining a threshold percentage of variance explained and the resulting p.

The method seeks to project the data into a lower dimensional space where each axis (or principal component) captures the most variability in the data subject to the condition of being uncorrelated to the other axes. This last condition is important for dimensionality reduction in the sense that large datasets can contain many correlated variables which hold no additional information.

An eigenvalue > 1 indicates that PCs account for more variance than accounted by one of the original variables in standardized data. This is commonly used as a cutoff point for which PCs are retained. This holds true only when the data are standardized. We can also limit the number of component to that number that accounts for a certain fraction of the total variance, for example 70%.

### ADHD Questionnaire

This section focuses on the subset of the data containing only the individual responses to the ADHD questionnaire. The table below displays the first 10 eigenvalues obtained from the decomposition. Following from the cutoff decription above, our selection of dimensions can be based on the number of scaled eigenvalues that are greater than 1 or on a certain percentage of cummulative variance explained. Another way to select the number of PCs to consider is to study the scree plot provided below, which is simply a visual representation of the variance explained by each component. We typically look for an elbow in the plot to make our selection. In our case, the scree plot elbow occurs at Dimensions = 2 and the eigenvalue threshold at Dimensions = 3 which account for 59.2% and 64.8% respectively. 

```{r message=FALSE, warning=FALSE}
adhd.full %>% select(ADHD.Q1:ADHD.Q18) %>%
  prcomp(scale = TRUE) %>% get_eigenvalue() %>% head(10)
```

```{r message=FALSE, warning=FALSE}
adhd.full %>% select(ADHD.Q1:ADHD.Q18) %>%
  prcomp(scale = FALSE) %>% 
  fviz_eig(addlabels = TRUE)
```

We can study the individual contributions of each questionnaire response to the principal components using the plot below. We observe that the contributions to the first principal component (Dim. 1) by the variables is roughly equivalent. However, Q16 bears a lot of weight in the 2nd dimension as Q5 does in the third dimension.

```{r message=FALSE, warning=FALSE}
res.pca.adhd <- adhd.full %>% select(ADHD.Q1:ADHD.Q18) %>% prcomp(scale = FALSE)
corrplot(get_pca_var(res.pca.adhd)$contrib, is.corr=FALSE)    
```

The cummulative contribution across the first 3 dimensions is summarized below. Q5 bears the most overall importance, followed by Q16 and Q4. It is worth diving into the actual questionnaire to look up what each question is asking to see if any insights can be drawn to explain the variability. The questions are listed below.

  - Q4: When you have a task that requires a lot of thought, how often do you avoid or delay getting started?
  - Q5: How often do you fidget or squirm with your hands or feet when you have to sit down for a long time?
  - Q16: When youâ€™re in a conversation, how often do you find yourself finishing the sentences of the people you are talking to, before they can finish them themselves?

```{r message=FALSE, warning=FALSE}
adhd.full %>% select(ADHD.Q1:ADHD.Q18) %>%
  prcomp(scale = FALSE) %>% 
  fviz_contrib(choice = "var", axes = 1:3, top = 10)
```

We can visualize these contribution in 2 dimensions using the first two PCs as shown below. On this plot, we look at the groupings and directions of the vectors. Positively correlated variables are grouped together. Negatively correlated variables are positioned on opposite sides of the plot origin. The distance between variables and the origin measures the contribution of the variables. We make the following observations:

  - Q16 is most red and shown as the most contributing variable in this representation due to it's importance in PC2 which we saw above. 
  - Q15, Q17 and Q18 are closely correlated while being away from the correlated vectors near the PC1 axis.
  - Most vectors hug the PC1 axis as can be explained from the fairly even contributions to PC1 reveale don the correlation plot.
  - Q16, A9, Q4 and Q5 have the largest distances from the origin and contribute similarly to PC1 but contribute quite differently to PC2 where Q16 dominates



```{r message=FALSE, warning=FALSE}
fviz_pca_var(res.pca.adhd,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
```

### Reduced Dataset

Using the resduced dataset, we can use PCA to extract additional information about the patients. Since we are using total scores for this section, the variables must be scaled in order to avoid any overweighted contributions. We find that it takes over 8 dimensions to explain approximately 70% of the variance. The scree plot has no obvious elbow which can be used to determine a cutoff. Using the eigenvalue cutoff at Dimension 7, we can still capture 65% of the variance.

```{r message=FALSE, warning=FALSE}
adhd.red.complete %>%
  prcomp(scale = TRUE) %>%get_eigenvalue() %>% head(10)
```

```{r message=FALSE, warning=FALSE}
adhd.red.complete %>%
  prcomp(scale = TRUE) %>% 
  fviz_eig(addlabels = TRUE)
```

From the correlation and variable contribution plots below, we can make a few observations:

- SubstDX is the largest contributor to PC1 by far
- ADHDTotal is the most important contribution to PC2
- Sedatives and Opiods contribute about equally to PC3
- Demographic factors Age, Race and Sex are the greatest contributors to PC4, 5 & 6 respectfully.
- Stimulants is the leading contribution to PC7 which is our cutoff.

```{r message=FALSE, warning=FALSE}
res.pca <- adhd.red.complete %>% prcomp(scale = TRUE)
corrplot(get_pca_var(res.pca)$contrib, is.corr=FALSE)    
```

Cummulatively for PC1 to PC7, we can observe from the below that SubstDX is the largest individual contributor to the principal components, followed by Age, Race and the two ADHD and Mood Disorder questionnaires.

```{r message=FALSE, warning=FALSE}
adhd.red.complete %>%
  prcomp(scale = TRUE) %>% 
  fviz_contrib(choice = "var", axes = 1:7, top = 10)
```


The 2D representation of the variable contributions to PC1 and PC2 are shown below. SubstDX has the largest contribution in the direction of the PC2 axis. In the same direction we can identify lesser but nevertheless present contributions from variables such as Violence, Conduct, Cocaine, THC and Alcohol. 



```{r message=FALSE, warning=FALSE}
fviz_pca_var(res.pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
```

[MI: add comments]

```{r message=FALSE, warning=FALSE}
fviz_pca_biplot(res.pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
```

# SVM
## SVM - Via Dataset
```{r}
adhd.complete2 <- adhd.red.complete
adhd.complete2$Suicide <- as.factor(adhd.complete2$Suicide)

set.seed(55)
trainIndex <- createDataPartition(adhd.complete2$Suicide, p = .8, list = FALSE, times = 1)
adhd.training <- adhd.complete2[ trainIndex,]
adhd.testing  <- adhd.complete2[-trainIndex,]
```

```{r}
svm_m <- tune(svm, Suicide ~., data = adhd.training, ranges=list(
  kernel=c("linear", "polynomial", "radial", "sigmoid"),
  cost=2^(2:8),
  epsilon = seq(0,1,0.1)))
summary(svm_m)
```

```{r}
svm_m_best <- svm_m$best.model
svm_pred <- predict(svm_m_best, newdata = adhd.testing, type="class")
svm_cm <- confusionMatrix(svm_pred, adhd.testing$Suicide)
svm_cm$table
sum(diag(svm_cm$table))/sum(svm_cm$table)
```
## SVM - Via PCA
```{r}
adhd_raw2 <- adhd_raw %>% select(-MD.TOTAL, -ADHD.Total, -Initial, -Psych.meds.)
adhd_raw2 <- adhd_raw2[complete.cases(adhd_raw2), ]
adhd_raw2$Suicide <- as.factor(adhd_raw2$Suicide)
set.seed(55)
trainIndex <- createDataPartition(adhd_raw2$Suicide, p = .8, list = FALSE, times = 1)
adhd_pca.training <- adhd_raw2[ trainIndex,]
adhd_pca.testing  <- adhd_raw2[-trainIndex,]
```

```{r}
svm_pca_m <- prcomp(select(adhd_pca.training, -Suicide), center = TRUE, scale = TRUE)
summary(svm_pca_m)

```
```{r}
fviz_eig(svm_pca_m, addlabels = T)

#check for normality and outliers, since we scaled the the original features, the qqplot should be normal as well
qqnorm(svm_pca_m[["x"]][,1])
```
```{r}
fviz_pca_ind(svm_pca_m, label="none", 
             habillage = adhd_pca.training$Suicide,
             addEllipses = TRUE, palette = "jco")
```
```{r}
#Kaiser rule: select PCs with eigenvalues of at least 1
reduced_dim <- get_eigenvalue(svm_pca_m) %>% filter(eigenvalue > 1)
reduced_dim
```
```{r}

adhd_pca.training_reduced <- cbind(as.data.frame(svm_pca_m$x[,c(1:nrow(reduced_dim))]), Suicide = adhd_pca.training$Suicide)
head(adhd_pca.training_reduced)

```
```{r}
#rotate the test data using the predict function in the same rotation as the training data
# rotation done with PC that have eigenvalue < 1 dropped
adhd_pca.testing_reduced <- cbind(as.data.frame(predict(svm_pca_m, newdata = select(adhd_pca.testing, -Suicide))[,c(1:nrow(reduced_dim))]),Suicide = adhd_pca.testing$Suicide)
head(adhd_pca.testing_reduced)
```
```{r}
svm_pca_m <- tune(svm, Suicide ~., data = adhd_pca.training_reduced, ranges=list(
  kernel=c("linear", "polynomial", "radial", "sigmoid"),
  cost=2^(2:8),
  epsilon = seq(0,1,0.1)))
summary(svm_pca_m)
```

```{r}
svm_pca_m_best <- svm_pca_m$best.model
svm_pca_pred <- predict(svm_pca_m_best, newdata = adhd_pca.testing_reduced, type="class")
svm_pca_cm <- confusionMatrix(svm_pca_pred, adhd_pca.testing_reduced$Suicide)
svm_pca_cm$table
sum(diag(svm_pca_cm$table))/sum(svm_pca_cm$table)
```


